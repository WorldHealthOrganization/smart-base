# JSON-LD ValueSet Vocabulary Usage Requirements

## Overview

This document provides comprehensive requirements and guidelines for using JSON-LD ValueSet vocabulary representations generated by the WHO SMART Base implementation guide. It covers how to reference these vocabularies in JSON-LD contexts, validate data against them, and use existing open source tooling.

**All examples use actual working ValueSets from smart-base** that can be accessed at their generated JSON-LD IRIs (Internationalized Resource Identifiers).

## Understanding IRIs vs URLs

In JSON-LD and RDF contexts, we use **IRIs (Internationalized Resource Identifiers)** rather than URLs. While they look similar, IRIs provide globally unique identification for resources in semantic web contexts. Learn more: [RFC 3987](https://tools.ietf.org/html/rfc3987)

## JSON-LD Named Graphs Structure

WHO SMART Base ValueSet vocabularies use [JSON-LD named graphs](https://www.w3.org/TR/json-ld11/#named-graphs) to organize content. Each vocabulary document follows this structure:

```json
{
  "@context": {
    "@version": 1.1,
    "name": "http://www.w3.org/2000/01/rdf-schema#label",
    "fhir": "https://smart.who.int/base/DataTypes.jsonld#",
    "id": "@id",
    "generatedAt": {
      "@id": "http://www.w3.org/ns/prov#generatedAtTime",
      "@type": "http://www.w3.org/2001/XMLSchema#dateTime"
    }
  },
  "@id": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
  "@type": "http://www.w3.org/ns/prov#Entity",
  "generatedAt": "2023-12-07T10:30:00Z",
  "@graph": [
    {
      "id": "https://smart.who.int/base/CodeSystem/DecisionTableActions.jsonld#output",
      "name": "Output",
      "fhir:code": "output",
      "fhir:CodeSystem": "https://smart.who.int/base/CodeSystem/DecisionTableActions"
    },
    {
      "id": "https://smart.who.int/base/CodeSystem/DecisionTableActions.jsonld#guidance", 
      "name": "Guidance",
      "fhir:code": "guidance",
      "fhir:CodeSystem": "https://smart.who.int/base/CodeSystem/DecisionTableActions"
    }
  ]
}
```

This provides:
- **Document identification**: The `@id` identifies the vocabulary as a whole
- **Provenance tracking**: `@type` and `generatedAt` follow [W3C PROV](https://www.w3.org/TR/prov-o/) standards
- **Content organization**: `@graph` contains all vocabulary definitions in a named graph structure

## 1. JSON-LD Context Declaration

### 1.1 Basic Context Setup

To use WHO SMART Base ValueSet JSON-LD vocabularies in your own JSON-LD documents, include them in your `@context`:

```json
{
  "@context": [
    {
      "@version": 1.1,
      "DecisionTableActions": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld"
    },
    {
      "action": {
        "@type": "@id",
        "schema:rangeIncludes": {
          "@id": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld"
        }
      }
    }
  ],
  "action": "https://smart.who.int/base/CodeSystem/DecisionTableActions.jsonld#output"
}
```

### 1.2 Multiple ValueSet References

When using multiple ValueSet vocabularies:

```json
{
  "@context": [
    {
      "@version": 1.1,
      "DecisionTableActions": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
      "CDSCv1": "https://smart.who.int/base/ValueSet-CDSCv1.jsonld"
    },
    {
      "action": {
        "@type": "@id",
        "schema:rangeIncludes": {
          "@id": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld"
        }
      },
      "systemCategory": {
        "@type": "@id", 
        "schema:rangeIncludes": {
          "@id": "https://smart.who.int/base/ValueSet-CDSCv1.jsonld"
        }
      }
    }
  ]
}
```

## 2. Setting Term Values from ValueSet JSON-LD

### 2.1 Direct Code Reference

Use the full IRI of the code as defined in the ValueSet JSON-LD:

```json
{
  "@context": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
  "action": "https://smart.who.int/base/CodeSystem/DecisionTableActions.jsonld#output"
}
```

### 2.2 Using FHIR Code Properties

Reference codes using their FHIR properties for explicit semantics:

```json
{
  "@context": [
    "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
    {
      "selectedCode": {
        "@type": "@id",
        "fhir:code": {
          "@type": "http://www.w3.org/2001/XMLSchema#string"
        },
        "fhir:system": {
          "@type": "@id"
        }
      }
    }
  ],
  "selectedCode": {
    "@id": "https://smart.who.int/base/CodeSystem/DecisionTableActions.jsonld#guidance",
    "fhir:code": "guidance",
    "fhir:system": "https://smart.who.int/base/CodeSystem/DecisionTableActions"
  }
}
```

## 2.3 Using @base for Short Fragment References

You can use JSON-LD's `@base` feature to create shorter references to codes from ValueSet vocabularies. This allows you to reference codes using fragment identifiers instead of full IRIs.

### 2.3.1 Document-level @base

Set `@base` at the document level to reference codes with short fragment syntax:

```json
{
  "@context": {
    "@version": 1.1,
    "@base": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
    "action": {
      "@id": "https://example.com/action",
      "@type": "@id"
    }
  },
  "action": "#output"
}
```

This expands to the full IRI: `https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld#output`

### 2.3.2 Property-level @base

Alternatively, you can set `@base` at the property level for more granular control:

```json
{
  "@context": {
    "@version": 1.1,
    "action": {
      "@base": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
      "@id": "https://example.com/action",
      "@type": "@id"
    }
  },
  "action": "#output"
}
```

**Note**: Property-level `@base` is **not** part of the JSON-LD 1.1 specification and should not be used. Always use document-level `@base` as shown in section 2.3.1.

### 2.3.3 Multiple ValueSet @base Usage

When working with multiple ValueSets, use document-level `@base` for the primary vocabulary and full IRIs for others:

```json
{
  "@context": {
    "@version": 1.1,
    "@base": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
    "primaryAction": {
      "@id": "https://example.com/primaryAction", 
      "@type": "@id"
    },
    "secondaryAction": {
      "@id": "https://example.com/secondaryAction",
      "@type": "@id"
    }
  },
  "primaryAction": "#output",
  "secondaryAction": "https://smart.who.int/base/ValueSet-OtherActions.jsonld#guidance"
}
```

### 2.3 Array of Values

When specifying multiple values from a ValueSet:

```json
{
  "@context": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
  "allowedActions": [
    "https://smart.who.int/base/CodeSystem/DecisionTableActions#output",
    "https://smart.who.int/base/CodeSystem/DecisionTableActions#guidance",
    "https://smart.who.int/base/CodeSystem/DecisionTableActions#annotation"
  ]
}
```

## 3. Validation Using Open Source Tooling

### 3.1 JSON Schema Validation

#### 3.1.1 Using ajv (Node.js)

```bash
npm install ajv ajv-formats
```

```javascript
const Ajv = require('ajv');
const addFormats = require('ajv-formats');

const ajv = new Ajv();
addFormats(ajv);

// Load the ValueSet JSON Schema (generated alongside JSON-LD)
const valueSetSchema = {
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "action": {
      "type": "string",
      "enum": [
        "https://smart.who.int/base/CodeSystem/DecisionTableActions#output",
        "https://smart.who.int/base/CodeSystem/DecisionTableActions#guidance",
        "https://smart.who.int/base/CodeSystem/DecisionTableActions#annotation"
      ]
    }
  }
};

const validate = ajv.compile(valueSetSchema);
const data = { action: "https://smart.who.int/base/CodeSystem/DecisionTableActions#output" };

if (validate(data)) {
  console.log('Valid!');
} else {
  console.log('Invalid:', validate.errors);
}
```

#### 3.1.2 Using jsonschema (Python)

```bash
pip install jsonschema requests
```

```python
import jsonschema
import requests
import json

# Load ValueSet JSON Schema
schema_url = "https://smart.who.int/base/ValueSet-DecisionTableActions.schema.json"
schema = requests.get(schema_url).json()

# Data to validate
data = {
    "action": "https://smart.who.int/base/CodeSystem/DecisionTableActions#guidance"
}

try:
    jsonschema.validate(instance=data, schema=schema)
    print("Valid!")
except jsonschema.ValidationError as e:
    print(f"Invalid: {e.message}")
```

### 3.2 RDF/JSON-LD Validation

#### 3.2.1 Using jsonld (Node.js)

```bash
npm install jsonld
```

```javascript
const jsonld = require('jsonld');

const doc = {
  "@context": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
  "action": "https://smart.who.int/base/CodeSystem/DecisionTableActions#annotation"
};

// Expand to check for valid JSON-LD
jsonld.expand(doc).then(expanded => {
  console.log('Valid JSON-LD:', JSON.stringify(expanded, null, 2));
}).catch(err => {
  console.error('Invalid JSON-LD:', err);
});

// Convert to RDF for semantic validation
jsonld.toRDF(doc).then(rdf => {
  console.log('RDF representation:', rdf);
}).catch(err => {
  console.error('RDF conversion failed:', err);
});
```

#### 3.2.2 Using pyld (Python)

```bash
pip install pyld
```

```python
from pyld import jsonld
import json

doc = {
    "@context": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
    "action": "https://smart.who.int/base/CodeSystem/DecisionTableActions#output"
}

try:
    # Expand to validate JSON-LD structure
    expanded = jsonld.expand(doc)
    print("Valid JSON-LD:", json.dumps(expanded, indent=2))
    
    # Convert to RDF triples
    rdf = jsonld.to_rdf(doc)
    print("RDF triples:", rdf)
    
except Exception as e:
    print(f"JSON-LD validation failed: {e}")
```

### 3.3 SPARQL Validation

#### 3.3.1 Using rdflib (Python)

```bash
pip install rdflib
```

```python
from rdflib import Graph, Namespace, URIRef
from rdflib.plugins.stores import sparqlstore

# Load the ValueSet JSON-LD into an RDF graph
g = Graph()
g.parse("https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld", format="json-ld")

# Define namespaces
FHIR = Namespace("http://hl7.org/fhir/")
VALUESET = Namespace("https://smart.who.int/base/")

# Validate that a code exists in the ValueSet
def validate_code(code_uri):
    query = f"""
    ASK {{
        <{code_uri}> a <https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld> .
    }}
    """
    
    result = g.query(query)
    return bool(result)

# Test validation
code_to_validate = "https://smart.who.int/base/CodeSystem/DecisionTableActions#guidance"
is_valid = validate_code(code_to_validate)
print(f"Code {code_to_validate} is {'valid' if is_valid else 'invalid'}")
```

### 3.4 SHACL Validation

#### 3.4.1 Creating SHACL Shapes

```turtle
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix base: <https://smart.who.int/base/> .
@prefix fhir: <http://hl7.org/fhir/> .
@prefix valueset: <https://smart.who.int/base/> .

base:DecisionTableActionShape
    a sh:NodeShape ;
    sh:targetClass base:Document ;
    sh:property [
        sh:path base:action ;
        sh:class valueset:ValueSet-DecisionTableActions.jsonld ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "action must be a valid value from the DecisionTableActions ValueSet" ;
    ] .
```

#### 3.4.2 Using pyshacl (Python)

```bash
pip install pyshacl
```

```python
from pyshacl import validate
from rdflib import Graph

# Load data graph
data_graph = Graph()
data_graph.parse(data="your-data.jsonld", format="json-ld")

# Load shapes graph
shapes_graph = Graph()
shapes_graph.parse("keyusage-shapes.ttl", format="turtle")

# Validate
conforms, results_graph, results_text = validate(
    data_graph,
    shacl_graph=shapes_graph,
    data_graph_format="json-ld",
    shacl_graph_format="turtle",
    inference="rdfs",
    debug=True
)

print(f"Conforms: {conforms}")
if not conforms:
    print("Validation errors:")
    print(results_text)
```

## 4. Logical Model Integration

### 4.1 Referencing ValueSets in Logical Models

When using ValueSet JSON-LD vocabularies with FHIR Logical Models:

```json
{
  "@context": [
    "https://smart.who.int/base/LogicalModel-YourModel.jsonld",
    "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld"
  ],
  "@type": "LogicalModel-YourModel",
  "codeProperty": {
    "@type": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
    "@id": "https://smart.who.int/base/CodeSystem/DecisionTableActions#output"
  }
}
```

### 4.2 Validation Against Logical Model Constraints

```python
# Example using JSON Schema validation for Logical Model + ValueSet
logical_model_schema = {
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "type": "object",
    "properties": {
        "@type": {"const": "LogicalModel-YourModel"},
        "codeProperty": {
            "type": "object",
            "properties": {
                "@type": {"const": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld"},
                "@id": {
                    "type": "string",
                    "enum": [
                        "https://smart.who.int/base/CodeSystem/DecisionTableActions#output",
                        "https://smart.who.int/base/CodeSystem/DecisionTableActions#guidance",
                        "https://smart.who.int/base/CodeSystem/DecisionTableActions#annotation"
                    ]
                }
            },
            "required": ["@type", "@id"]
        }
    },
    "required": ["@type", "codeProperty"]
}
```

## 5. Best Practices

### 5.1 Context Management

1. **Use explicit contexts**: Always declare ValueSet JSON-LD vocabularies in your `@context`
2. **Namespace properly**: Use full IRIs for unambiguous code references
3. **Version awareness**: Include version information when referencing specific ValueSet versions

### 5.2 Validation Strategy

1. **Multi-layer validation**: Use both JSON Schema and RDF validation
2. **Early validation**: Validate at data entry points
3. **Continuous validation**: Re-validate when ValueSets are updated

### 5.3 Performance Considerations

1. **Cache contexts**: Cache JSON-LD contexts to avoid repeated network requests
2. **Batch validation**: Validate multiple documents together when possible
3. **Incremental loading**: Load only required ValueSets for specific use cases

## 6. Error Handling

### 6.1 Common Validation Errors

```javascript
// Example error handling for different validation failures

function validateValueSetCode(code, valueSetUrl) {
    try {
        // JSON Schema validation
        const isSchemaValid = validateWithJsonSchema(code);
        if (!isSchemaValid) {
            throw new Error(`Code ${code} not in ValueSet schema`);
        }
        
        // JSON-LD context validation
        const isContextValid = validateJsonLdContext(code, valueSetUrl);
        if (!isContextValid) {
            throw new Error(`Code ${code} not valid in JSON-LD context`);
        }
        
        return { valid: true };
        
    } catch (error) {
        return { 
            valid: false, 
            error: error.message,
            code: code,
            valueSet: valueSetUrl
        };
    }
}
```

### 6.2 Graceful Degradation

```javascript
// Handle cases where ValueSet JSON-LD is unavailable
async function loadValueSetWithFallback(valueSetUrl) {
    try {
        const context = await fetch(valueSetUrl);
        return await context.json();
    } catch (error) {
        console.warn(`Failed to load ValueSet ${valueSetUrl}, using cached version`);
        return getCachedValueSet(valueSetUrl);
    }
}
```

## 7. Integration Examples

### 7.1 Web Application Integration

```html
<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/jsonld@8.3.0/dist/jsonld.min.js"></script>
</head>
<body>
    <script>
        async function validateUserInput(userCode) {
            const doc = {
                "@context": "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld",
                "userSelection": userCode
            };
            
            try {
                const expanded = await jsonld.expand(doc);
                return { valid: true, expanded };
            } catch (error) {
                return { valid: false, error: error.message };
            }
        }
    </script>
</body>
</html>
```

### 7.2 API Integration

```python
from fastapi import FastAPI, HTTPException
from pyld import jsonld
import requests

app = FastAPI()

@app.post("/validate-code")
async def validate_code(code: str, valueset_url: str):
    try:
        # Load ValueSet context
        context = requests.get(valueset_url).json()
        
        # Create document to validate
        doc = {
            "@context": valueset_url,
            "code": code
        }
        
        # Validate JSON-LD
        expanded = jsonld.expand(doc)
        
        return {"valid": True, "expanded": expanded}
        
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Validation failed: {str(e)}")
```

## 8. Standards Compliance

This document ensures compliance with:

- [JSON-LD 1.1 Specification](https://www.w3.org/TR/json-ld11/)
- [RDF 1.1 Concepts](https://www.w3.org/TR/rdf11-concepts/)
- [FHIR R4 Specification](http://hl7.org/fhir/R4/)
- [Schema.org Vocabulary](https://schema.org/)
- [SHACL Specification](https://www.w3.org/TR/shacl/)

## 9. Tooling Reference

### 9.1 JSON-LD Processors
- **JavaScript**: [jsonld.js](https://github.com/digitalbazaar/jsonld.js)
- **Python**: [PyLD](https://github.com/digitalbazaar/pyld)
- **Java**: [JSON-LD Java](https://github.com/jsonld-java/jsonld-java)
- **C#**: [json-ld.net](https://github.com/linked-data-dotnet/json-ld.net)

### 9.2 RDF Libraries
- **Python**: [rdflib](https://rdflib.readthedocs.io/)
- **JavaScript**: [N3.js](https://github.com/rdfjs/N3.js)
- **Java**: [Apache Jena](https://jena.apache.org/)
- **C#**: [dotNetRDF](https://www.dotnetrdf.org/)

### 9.3 Validation Tools
- **JSON Schema**: [ajv](https://ajv.js.org/), [jsonschema](https://python-jsonschema.readthedocs.io/)
- **SHACL**: [pyshacl](https://github.com/RDFLib/pySHACL), [TopBraid SHACL](https://github.com/TopQuadrant/shacl)
- **RDF**: [EYE reasoner](https://github.com/eyereasoner/eye), [Pellet](https://github.com/stardog-union/pellet)

## 10. Maintenance and Updates

### 10.1 Version Management
- Always specify version-specific URLs when possible
- Implement change detection for ValueSet updates
- Use semantic versioning for breaking changes

### 10.2 Monitoring
- Monitor ValueSet availability and response times
- Track validation error rates
- Log context resolution failures

## 10. Accessing Working Smart-Base Examples

### 10.1 Available ValueSet JSON-LD Vocabularies

All smart-base ValueSets generate corresponding JSON-LD vocabularies accessible at:

- **DecisionTableActions**: `https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld`
  - Codes: `output`, `guidance`, `annotation`
- **CDSCv1**: `https://smart.who.int/base/ValueSet-CDSCv1.jsonld`
  - Codes: `A`, `B`, `C`, etc. (Digital Health System Categories)
- **ISCO08ValueSet**: `https://smart.who.int/base/ValueSet-ISCO08ValueSet.jsonld`
  - Codes: Occupation codes from International Labour Organization
- **SGPersonaTypes**: `https://smart.who.int/base/ValueSet-SGPersonaTypesVS.jsonld`
  - Codes: `key`, `related`, `system`, `hardware`

### 10.2 Preview Access During Development

During development and pull request review, preview versions are available at:
```
https://smart.who.int/base/branches/{branch-name}/ValueSet-{ValueSetId}.jsonld
```

For example, this PR's changes can be previewed at:
```
https://smart.who.int/base/branches/fix-164/ValueSet-DecisionTableActions.jsonld
```

### 10.3 Verification Examples

You can verify the JSON-LD vocabulary structure by fetching any of these IRIs directly:

```bash
# Fetch DecisionTableActions vocabulary
curl -H "Accept: application/ld+json" \
  "https://smart.who.int/base/ValueSet-DecisionTableActions.jsonld"

# Fetch CDSCv1 vocabulary  
curl -H "Accept: application/ld+json" \
  "https://smart.who.int/base/ValueSet-CDSCv1.jsonld"
```

This requirements document provides comprehensive guidance for implementing robust, standards-compliant systems that use WHO SMART Base JSON-LD ValueSet vocabularies with actual working examples.