# DAK API Documentation Hub Generator

## Overview

The `generate_dak_api_hub.py` script creates a unified API documentation hub (`dak-api.html`) for WHO SMART Guideline Digital Adaptation Kits (DAKs). It provides a single entry point to browse all JSON schemas and OpenAPI specifications with a consistent, FHIR IG-styled interface.

## Features

- **Unified Hub**: Single `dak-api.html` page linking to all API documentation
- **JSON Schema Support**: Automatically wraps ValueSet and Logical Model schemas in OpenAPI format
- **OpenAPI Integration**: Detects and includes existing OpenAPI/Swagger specifications
- **Self-contained Documentation**: Generates static HTML files without external dependencies
- **FHIR IG Styling**: Consistent look and feel matching FHIR Implementation Guides

## Usage

### Basic Usage
```bash
# Run with default paths (output -> output/, openapi -> input/images/openapi)
python input/scripts/generate_dak_api_hub.py

# Specify output directory only
python input/scripts/generate_dak_api_hub.py output

# Specify both output and OpenAPI directories
python input/scripts/generate_dak_api_hub.py output input/images/openapi
```

### Integration with Build Pipeline

The script should be run after the existing schema generation scripts:

```bash
# 1. Generate ValueSet schemas
python input/scripts/generate_valueset_schemas.py

# 2. Generate Logical Model schemas  
python input/scripts/generate_logical_model_schemas.py

# 3. Generate unified API documentation hub
python input/scripts/generate_dak_api_hub.py
```

## Prerequisites

- Python 3.6+
- PyYAML library (usually available by default)
- Existing JSON schema files (generated by ValueSet and Logical Model generators)
- Optional: OpenAPI/Swagger files in `input/images/openapi` directory

## Input Requirements

### JSON Schemas
- ValueSet schemas: Files matching pattern `ValueSet-*.schema.json`
- Logical Model schemas: Files matching pattern `StructureDefinition-*.schema.json`
- Other schemas: Any remaining `*.schema.json` files (excluding ValueSet and CodeSystem)
- Must be valid JSON Schema files with `$schema`, `$id`, `title`, and `description` fields

### OpenAPI Files
- Location: `input/images/openapi` directory (configurable)
- Naming: Files must contain "openapi" or "swagger" in filename
- Formats: `.yaml`, `.yml`, or `.json`
- Must be valid OpenAPI 3.0+ specifications

## Output Structure

The script generates:

```
output/
├── dak-api.html                           # Main documentation hub
├── {schema-name}.openapi.yaml             # OpenAPI wrappers for schemas
├── {schema-name}.html                     # Individual schema documentation
└── {existing-openapi-name}.html           # OpenAPI specification documentation
```

## Generated Documentation Types

### ValueSet Documentation
- Shows enumerated values from the schema
- Displays FHIR metadata (canonical URL, version, expansion timestamp)
- Provides downloadable JSON schema

### Logical Model Documentation  
- Shows object properties with types and descriptions
- Highlights required fields
- Displays full schema structure
- Shows relationships to ValueSet schemas via `$ref`

### OpenAPI Documentation
- Displays API endpoints with HTTP methods
- Shows request/response schemas
- Renders component schemas with properties and types
- Maintains original API structure and metadata

## Customization

### Styling
The generated HTML uses FHIR IG-inspired styling with:
- Blue color scheme (`#0066cc`)
- Modern card-based layout
- Responsive design
- Professional typography

### OpenAPI Wrapper Format
Each JSON schema is wrapped in a minimal OpenAPI 3.0 specification:

```yaml
openapi: 3.0.3
info:
  title: "{Schema Title} API"
  description: "{Schema Description}"
  version: "1.0.0"
paths:
  /{schema-filename}:
    get:
      summary: "JSON Schema definition for {type} {name}"
      responses:
        '200':
          content:
            application/schema+json:
              schema:
                $ref: './{schema-filename}'
```

## Error Handling

The script handles common scenarios gracefully:
- Missing directories (creates empty hub with helpful message)
- Invalid schema files (skips with warning)
- Missing OpenAPI files (continues without OpenAPI section)
- Malformed YAML/JSON (logs error and continues)

## Troubleshooting

### dak-api.html Not Found Error
**Error**: `❌ Cannot find dak-api.html in output directory`
**Solution**: This script is a post-processor that requires the IG publisher to run first.
1. Run the IG publisher to generate `dak-api.html` from `input/pagecontent/dak-api.md`
2. Then run this script to post-process the generated HTML
3. Use the correct build order: `./build-with-dak-api.sh` or `./_genonce.sh` then `python3 input/scripts/generate_dak_api_hub.py output`

### No Documentation Generated
1. Ensure schema files exist in the output directory
2. Check that schema files have proper JSON Schema format
3. Verify file permissions

### OpenAPI Files Not Detected  
1. Ensure filenames contain "openapi" or "swagger"
2. Check file format is `.yaml`, `.yml`, or `.json`
3. Verify OpenAPI directory exists and is accessible

### Styling Issues
- All styling is embedded in the HTML files
- No external dependencies required
- Should work in any modern web browser

## Example Integration

Add to your IG build script:
```bash
#!/bin/bash

# Run FHIR IG Publisher first (creates dak-api.html from dak-api.md)
java -jar publisher.jar -ig .

# Generate schema documentation (if needed)
python input/scripts/generate_valueset_schemas.py
python input/scripts/generate_logical_model_schemas.py

# Post-process: Generate unified API hub (requires dak-api.html to exist)
python input/scripts/generate_dak_api_hub.py

echo "API documentation hub post-processed at output/dak-api.html"
```